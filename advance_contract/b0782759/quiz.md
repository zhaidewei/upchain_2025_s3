# [quiz](https://decert.me/challenge/b0782759-4995-4bcb-85c2-2af749f0fde9)

使用Viem 利用 getStorageAt 从链上读取 _locks 数组中的所有元素值，并打印出如下内容：
locks[0]: user:…… ,startTime:……,amount:……

```solidity
ontract esRNT {
    struct LockInfo{
        address user;
        uint64 startTime;
        uint256 amount;
    }
    LockInfo[] private _locks;

    constructor() {
        for (uint256 i = 0; i < 11; i++) {
            _locks.push(LockInfo(address(uint160(I+1)), uint64(block.timestamp*2-i), 1e18*(i+1)));
        }
    }
}
```

## Analysis

There is a `_locks` object in EVM storage. Its starting position is keccak(slot 0)
And each element of its is a struct,
This value is defined as private, so there is no method to expose it to the code.
Only way to read it is to get the complete storage of this contract.

size: 20Bytes address + 8 bytes startTime ==> these two are packed into 1 byte

32 bytes amount.

Let's check the `getStorageAt` method from viem

```typescript
import { toHex } from 'viem'
import { createPublicClient, http } from 'viem'
import { anvil } from 'viem/chains'

const publicClient = createPublicClient({
        chain: anvil,
        transport: http()
    })

const data = await publicClient.getStorageAt(
    {
        address: '0x5FbDB2315678afecb367f032d93F642f64180aa3',
        slot: toHex(0)
    })
consol.log(data)
```

Let's check the EVM storage rules for dynamic list of self defined struct type.
1. slot 0 address store the length
2. start_slot = keccak256(slot #) decides the start slot for the first element
3. First element slot number = start_slot + 0, second element slot = start_slot + 1

Note:
1. keccak256 works on bytes, so '0x0' is different from '0x00000000....0' (32)
2. the Keccak256(slot p) is a byte -> bigInt then we can add 1 , 2 etc to get the slot number

### Log

Deployed the contract
`forge create $PWD/src/esRNT.sol:esRNT --account anvil-tester --password '' --broadcast --rpc-url http://localhost:8545`

```sh
tsx show.ts                                          ✔  10165  01:32:04
The total length of the array is 11
baseSlot: 0x290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e563
userSlot: 18569430475105882587588266137607568536673111973893317399460219858819262702947
amountSlot: 18569430475105882587588266137607568536673111973893317399460219858819262702948
userData: 0x0000000000000000d11479840000000000000000000000000000000000000001
amountData: 0x0000000000000000000000000000000000000000000000000de0b6b3a7640000
user: 0x0000000000000000000000000000000000000001, startTime: 3507779972, amount: 1000000000000000000
userSlot: 18569430475105882587588266137607568536673111973893317399460219858819262702949
amountSlot: 18569430475105882587588266137607568536673111973893317399460219858819262702950
userData: 0x0000000000000000d11479830000000000000000000000000000000000000002
amountData: 0x0000000000000000000000000000000000000000000000001bc16d674ec80000
user: 0x0000000000000000000000000000000000000002, startTime: 3507779971, amount: 2000000000000000000
userSlot: 18569430475105882587588266137607568536673111973893317399460219858819262702951
amountSlot: 18569430475105882587588266137607568536673111973893317399460219858819262702952
userData: 0x0000000000000000d11479820000000000000000000000000000000000000003
amountData: 0x00000000000000000000000000000000000000000000000029a2241af62c0000
user: 0x0000000000000000000000000000000000000003, startTime: 3507779970, amount: 3000000000000000000
userSlot: 18569430475105882587588266137607568536673111973893317399460219858819262702953
amountSlot: 18569430475105882587588266137607568536673111973893317399460219858819262702954
userData: 0x0000000000000000d11479810000000000000000000000000000000000000004
amountData: 0x0000000000000000000000000000000000000000000000003782dace9d900000
user: 0x0000000000000000000000000000000000000004, startTime: 3507779969, amount: 4000000000000000000
userSlot: 18569430475105882587588266137607568536673111973893317399460219858819262702955
amountSlot: 18569430475105882587588266137607568536673111973893317399460219858819262702956
userData: 0x0000000000000000d11479800000000000000000000000000000000000000005
amountData: 0x0000000000000000000000000000000000000000000000004563918244f40000
user: 0x0000000000000000000000000000000000000005, startTime: 3507779968, amount: 5000000000000000000
userSlot: 18569430475105882587588266137607568536673111973893317399460219858819262702957
amountSlot: 18569430475105882587588266137607568536673111973893317399460219858819262702958
userData: 0x0000000000000000d114797f0000000000000000000000000000000000000006
amountData: 0x00000000000000000000000000000000000000000000000053444835ec580000
user: 0x0000000000000000000000000000000000000006, startTime: 3507779967, amount: 6000000000000000000
userSlot: 18569430475105882587588266137607568536673111973893317399460219858819262702959
amountSlot: 18569430475105882587588266137607568536673111973893317399460219858819262702960
userData: 0x0000000000000000d114797e0000000000000000000000000000000000000007
amountData: 0x0000000000000000000000000000000000000000000000006124fee993bc0000
user: 0x0000000000000000000000000000000000000007, startTime: 3507779966, amount: 7000000000000000000
userSlot: 18569430475105882587588266137607568536673111973893317399460219858819262702961
amountSlot: 18569430475105882587588266137607568536673111973893317399460219858819262702962
userData: 0x0000000000000000d114797d0000000000000000000000000000000000000008
amountData: 0x0000000000000000000000000000000000000000000000006f05b59d3b200000
user: 0x0000000000000000000000000000000000000008, startTime: 3507779965, amount: 8000000000000000000
userSlot: 18569430475105882587588266137607568536673111973893317399460219858819262702963
amountSlot: 18569430475105882587588266137607568536673111973893317399460219858819262702964
userData: 0x0000000000000000d114797c0000000000000000000000000000000000000009
amountData: 0x0000000000000000000000000000000000000000000000007ce66c50e2840000
user: 0x0000000000000000000000000000000000000009, startTime: 3507779964, amount: 9000000000000000000
userSlot: 18569430475105882587588266137607568536673111973893317399460219858819262702965
amountSlot: 18569430475105882587588266137607568536673111973893317399460219858819262702966
userData: 0x0000000000000000d114797b000000000000000000000000000000000000000a
amountData: 0x0000000000000000000000000000000000000000000000008ac7230489e80000
user: 0x000000000000000000000000000000000000000a, startTime: 3507779963, amount: 10000000000000000000
userSlot: 18569430475105882587588266137607568536673111973893317399460219858819262702967
amountSlot: 18569430475105882587588266137607568536673111973893317399460219858819262702968
userData: 0x0000000000000000d114797a000000000000000000000000000000000000000b
amountData: 0x00000000000000000000000000000000000000000000000098a7d9b8314c0000
user: 0x000000000000000000000000000000000000000b, startTime: 3507779962, amount: 11000000000000000000
```
